# Database Migrations

This directory contains database migration scripts for the gen-ai-examples project, using SQLAlchemy and Alembic with PostgreSQL and pgvector, following AWS best practices.

## Table of Contents

1. [Overview](#overview)
2. [Directory Structure](#directory-structure)
3. [Prerequisites](#prerequisites)
4. [Usage](#usage)
5. [Creating New Migrations](#creating-new-migrations)
6. [AWS RDS Integration](#aws-rds-integration)

## Overview

The migrations directory contains Alembic-based database migration scripts that manage the evolution of the database schema for the gen-ai-examples project. These migrations ensure that the database structure stays in sync with the application code and can be applied consistently across different environments.

## Directory Structure

- `versions/`: Contains individual migration scripts
- `env.py`: Alembic environment configuration
- `script.py.mako`: Template for generating new migration scripts
- `alembic.ini`: Alembic configuration file

## Prerequisites

Before using these migrations, ensure you have:

1. PostgreSQL with pgvector extension installed
2. SQLAlchemy and Alembic installed:
   ```bash
   pip install -r requirements.txt
   ```
3. Environment variables configured in `.env`:
   ```bash
   PGVECTOR_HOST=your_rds_instance.region.rds.amazonaws.com
   PGVECTOR_PORT=5432
   PGVECTOR_USER=postgres
   PGVECTOR_PASSWORD=your_password
   PGVECTOR_DATABASE=vector_db
   ```

## Usage

### Applying Migrations

To apply all pending migrations to bring the database up to the latest version:

```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific number of migrations
alembic upgrade +2

# Upgrade to a specific migration
alembic upgrade 1a2b3c4d5e6f
```

### Reverting Migrations

To revert migrations and roll back the database schema:

```bash
# Revert the most recent migration
alembic downgrade -1

# Revert all migrations
alembic downgrade base

# Revert to a specific migration
alembic downgrade 1a2b3c4d5e6f
```

### Viewing Migration History

To view the migration history and current state:

```bash
# View migration history
alembic history

# View current revision
alembic current
```

## Creating New Migrations

To create a new migration script:

```bash
# Create a new migration with autogenerate
alembic revision --autogenerate -m "Add user table"

# Create a new empty migration
alembic revision -m "Custom migration"
```

When creating a new migration, follow these best practices:

1. Give the migration a descriptive name that explains what it does
2. Review autogenerated migrations for accuracy
3. Add comments to explain complex changes
4. Test migrations in a development environment before applying to production
5. Include both upgrade and downgrade paths

### Example Migration

```python
"""Add vector index

Revision ID: 1a2b3c4d5e6f
Revises: 9z8y7x6w5v4u
Create Date: 2023-01-15 10:30:45.678901

"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic
revision = '1a2b3c4d5e6f'
down_revision = '9z8y7x6w5v4u'
branch_labels = None
depends_on = None


def upgrade():
    # Create index on the embedding column
    op.execute(
        "CREATE INDEX IF NOT EXISTS embeddings_idx ON documents "
        "USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);"
    )


def downgrade():
    # Drop the index
    op.execute("DROP INDEX IF EXISTS embeddings_idx;")
```

## AWS RDS Integration

These migrations are designed to work with AWS RDS Aurora PostgreSQL Serverless v2. To set up pgvector on AWS RDS:

### 1. Create a Parameter Group for pgvector

```bash
aws rds create-db-parameter-group \
    --db-parameter-group-name pgvector-pg-13 \
    --db-parameter-group-family postgres13 \
    --description "Parameter group for pgvector extension"
```

### 2. Create the RDS Instance

```bash
aws rds create-db-instance \
    --db-instance-identifier pgvector-instance \
    --db-parameter-group-name pgvector-pg-13 \
    --db-instance-class db.t3.medium \
    --engine postgres \
    --engine-version 13.4 \
    --allocated-storage 20 \
    --master-username postgres \
    --master-user-password your_strong_password \
    --port 5432 \
    --no-publicly-accessible \
    --vpc-security-group-ids sg-your_security_group_id
```

### 3. Install the pgvector Extension

Connect to your RDS instance and create the extension:

```sql
CREATE DATABASE vector_db;
\c vector_db

-- Install the pgvector extension
CREATE EXTENSION vector;

-- Verify installation
\dx
```

### 4. Run the Migrations

Update your `.env` file with the RDS connection details and run the migrations:

```bash
# Update .env with RDS details
PGVECTOR_HOST=your-pgvector-instance.region.rds.amazonaws.com
PGVECTOR_PORT=5432
PGVECTOR_USER=postgres
PGVECTOR_PASSWORD=your_strong_password
PGVECTOR_DATABASE=vector_db

# Run the migrations
alembic upgrade head
```

For more detailed information on using pgvector with AWS RDS, refer to the `vector_db/README.md` file.
